<?php
/*
 +-------------------------------------------------------------------------+
 | Copyright (C) 2007 The Cacti Group                                      |
 |                                                                         |
 | This program is free software; you can redistribute it and/or           |
 | modify it under the terms of the GNU General Public License             |
 | as published by the Free Software Foundation; either version 2          |
 | of the License, or (at your option) any later version.                  |
 |                                                                         |
 | This program is distributed in the hope that it will be useful,         |
 | but WITHOUT ANY WARRANTY; without even the implied warranty of          |
 | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           |
 | GNU General Public License for more details.                            |
 +-------------------------------------------------------------------------+
 | Cacti: The Complete RRDTool-based Graphing Solution                     |
 +-------------------------------------------------------------------------+
 | This code is designed, written, and maintained by the Cacti Group. See  |
 | about.php and/or the AUTHORS file for specific developer information.   |
 +-------------------------------------------------------------------------+
 | http://www.cacti.net/                                                   |
 +-------------------------------------------------------------------------+
*/

function plugin_linkdiscovery_install () {
	api_plugin_register_hook('linkdiscovery', 'top_header_tabs', 'linkdiscovery_show_tab', 'setup.php');
	api_plugin_register_hook('linkdiscovery', 'top_graph_header_tabs', 'linkdiscovery_show_tab', 'setup.php');
	api_plugin_register_hook('linkdiscovery', 'config_arrays', 'linkdiscovery_config_arrays', 'setup.php'); // array used by this plugin
	api_plugin_register_hook('linkdiscovery', 'config_settings', 'linkdiscovery_config_settings', 'setup.php'); // personl settings info
	api_plugin_register_hook('linkdiscovery', 'draw_navigation_text', 'linkdiscovery_draw_navigation_text', 'setup.php'); // nav bar under console and grpah tab
	api_plugin_register_hook('linkdiscovery', 'poller_bottom', 'linkdiscovery_poller_bottom', 'setup.php'); // define and setting of personal poller
	api_plugin_register_hook('linkdiscovery', 'api_device_new', 'linkdiscovery_add_device', 'setup.php'); // add a device to efficientIP 
	api_plugin_register_hook('linkdiscovery', 'utilities_action', 'linkdiscovery_utilities_action', 'setup.php');
	api_plugin_register_hook('linkdiscovery', 'utilities_list', 'linkdiscovery_utilities_list', 'setup.php');
	api_plugin_register_hook('linkdiscovery', 'device_remove', 'linkdiscovery_device_remove', 'setup.php');

	api_plugin_register_realm('linkdiscovery', 'linkdiscovery.php,linkdiscovery_template.php', 'Plugin -> LinkDiscovery', 1);

	linkdiscovery_setup_table();
}

function plugin_linkdiscovery_uninstall () {
	// Do any extra Uninstall stuff here
}

function plugin_linkdiscovery_check_config () {
	// Here we will check to ensure everything is configured
	linkdiscovery_check_upgrade ();
	return true;
}

function plugin_linkdiscovery_upgrade () {
	// Here we will upgrade to the newest version
	linkdiscovery_check_upgrade ();
	return false;
}

function linkdiscovery_version () {
	return plugin_linkdiscovery_version();
}

function linkdiscovery_check_upgrade () {
	global $config, $database_default;
	include_once($config["library_path"] . "/database.php");
	include_once($config["library_path"] . "/functions.php");

	// Let's only run this check if we are on a page that actually needs the data
	$files = array('plugins.php', 'linkdiscovery.php', 'findhost.php');
	if (isset($_SERVER['PHP_SELF']) && !in_array(basename($_SERVER['PHP_SELF']), $files)) {
		return;
	}

	$version = plugin_linkdiscovery_version ();
	$current = $version['version'];
	$old = read_config_option('plugin_linkdiscovery_version');
	if ($current != $old) {

		// Set the new version
		db_execute("UPDATE plugin_config SET version='$current' WHERE directory='linkdiscovery'");
		db_execute("UPDATE plugin_config SET " .
				"version='" . $version["version"] . "', " .
				"name='" . $version["longname"] . "', " .
				"author='" . $version["author"] . "', " .
				"webpage='" . $version["url"] . "' " .
				"WHERE directory='" . $version["name"] . "' ");
	}
}

function linkdiscovery_check_dependencies() {
	global $plugins, $config, $thold, $monitor;
	if ((!in_array('settings', $plugins)) &&
		(db_fetch_cell("SELECT directory FROM plugin_config WHERE directory='settings' AND status=1") == "")) {
		return false;
	}

	// check thold
	if ((!in_array('settings', $plugins)) &&
		(db_fetch_cell("SELECT directory FROM plugin_config WHERE directory='thold' AND status=1") == "")) {
		$thold = false;
	}

	// check monitor
	if ((!in_array('settings', $plugins)) &&
		(db_fetch_cell("SELECT directory FROM plugin_config WHERE directory='monitor' AND status=1") == "")) {
		$monitor = false;
	}

	if (!function_exists('settings_version')) {
		if (file_exists($config['base_path'] . '/plugins/settings/setup.php')) {
			include_once($config['base_path'] . '/plugins/settings/setup.php');
			if (!function_exists('settings_version')) {
				return false;
			}
		}
	}
	$v = settings_version();
	if (!isset($v['version']) || $v['version'] < 0.3) {
		return false;
	}

	return true;
}

function plugin_linkdiscovery_version () {
	return array(
		'name'     => 'LinkDiscovery',
		'version'  => '0.42',
		'longname' => 'Network Link Discovery',
		'author'   => 'Arno Streuli',
		'homepage' => 'http://cactiusers.org',
		'email'    => 'astreuli@gmail.com',
		'url'      => 'http://versions.cactiusers.org/'
	);
}

function linkdiscovery_config_settings () {
	global $tabs, $settings, $linkdiscovery_poller_frequencies, $linkdiscovery_get_host_template, $linkdiscovery_cpu_graph;
	$tabs["misc"] = "Misc";

	if (isset($_SERVER['PHP_SELF']) && basename($_SERVER['PHP_SELF']) != 'settings.php')
		return;

	// get device list
	$host_names = db_fetch_assoc("SELECT id, hostname FROM host WHERE DISABLED!='ON' ORDER BY hostname");
	$sample_host_names = array();

	if (sizeof($host_names) > 0) {
		foreach ($host_names as $ht) {
			$sample_host_names[$ht['id']] = $ht['hostname'];
		}
	}

	$tabs['LinkDiscovery'] = 'LinkDiscovery';
	$settings['LinkDiscovery'] = array(
		"linkdiscovery_general_header" => array(
			"friendly_name" => "General",
			"method" => "spacer",
			),
		"linkdiscovery_seed" => array(
			"friendly_name" => "Seed device to start the scan",
			"description" => "This is the device where we will start the scan.",
			"method" => "drop_array",
			"value" => "|arg1:host_name|",
			"array" => $sample_host_names,
			),
		"linkdiscovery_domain_name" => array(
			"friendly_name" => "Domain Name for DNS",
			"description" => "Either due to equipment configuration or discovery protocol implementation, a hostname reported by/to a device may not be reported/stored in a fully qualified state. It is strongly suggested you fill this in with the domain name your network equipment is found in (E.G., 'net.yourcompany.com') without a leading or trailing '.'.  It will be appended to hostnames that do not appear to be fully qualified domain names (FQDN).",
			"method" => "textbox",
			"max_length" => 255,
			"default" => ""
			),
		'linkdiscovery_use_ip_hostname' => array(
			'friendly_name' => "Use IP For Hostname",
			'description' => "For a device to be added to Cacti, the IP must be resolved via DNS.  When adding the device, do you want to use the detected IP as the Cacti hostname?  Yes will reduce queries against the DNS server for the system and give a greater chance of polling occurring should DNS fail somewhere along the line.  No means the derived FQDN will be used instead.",
			'method' => 'checkbox',
			'default' => 'off',
			),
		'linkdiscovery_use_fqdn_for_description' => array(
			'friendly_name' => "Use FQDN for Description",
			'description' => "If checked, when adding a device, the device's fully qualified domain name (however it was derived) will be used for the Cacti Description.  If unchecked, the 'short' host name (everything before the first '.') will be used instead.",
			"method" => 'checkbox',
			"default" => "off",
			),
		'linkdiscovery_update_hostname' => array(
			'friendly_name' => "Update the hostname field with FQDN if available",
			'description' => "When discovered, if a device exist into cacti, the hostname will be set to the FQDN value we can retrive either way from the CDP name or the CDP ip.",
			'method' => 'checkbox',
			'default' => 'off',
			),
		"linkdiscovery_collection_timing" => array(
			"friendly_name" => "Poller Frequency",
			"description" => "Choose how often to attempt to find devices on  your network.",
			"method" => "drop_array",
			"default" => "disabled",
			"array" => $linkdiscovery_poller_frequencies,
			),
		"linkdiscovery_base_time" => array(
			"friendly_name" => "Start Time for Polling",
			"description" => "When would you like the first polling to take place.  All future polling times will be based upon this start time.  A good example would be 12:00AM.",
			"default" => "12:00am",
			"method" => "textbox",
			"max_length" => "10"
			),
		'linkdiscovery_monitor' => array(
			'friendly_name' => 'Enable Monitor',
			'description' => 'Enable monitor for the new device',
			'method' => 'checkbox',
			'default' => 'off'
			),
		"linkdiscovery_CDP_deepness" => array(
			"friendly_name" => "How deep CDP go",
			"description" => "Define how many CDP level we go from the seed device.",
			"default" => "1",
			"method" => "textbox",
			"max_length" => "3"
			),
		'linkdiscovery_useipam' => array(
			'friendly_name' => 'Use the EfficientIP netchange ?',
			'description' => 'Fill EfficientIP Netchange product when a host is added.',
			'method' => 'checkbox',
			'default' => 'off'
			),
		"linkdiscovery_ipam_url" => array(
			"friendly_name" => "URL of the EfficientIP server",
			"description" => "URL of the EfficientIP server.",
			"method" => "textbox",
			"max_length" => 80,
			"default" => ""
			),
		'linkdiscovery_aruba_server' => array(
			'friendly_name' => "Aruba ClearPass URL server",
			'description' => 'URL of the Aruba server where will be addedd all newly discovered device',
			"method" => "textbox",
			"max_length" => 80,
			"default" => ""
		),
		'linkdiscovery_aruba_radius_secret' => array(
			'friendly_name' => "Aruba ClearPass radius secret",
			'description' => 'The radius secret for a new device',
			"method" => "textbox_password",
			"max_length" => 80,
			"default" => ""
		),
		'linkdiscovery_aruba_tacacs_secret' => array(
			'friendly_name' => "Aruba ClearPass tacacs secret",
			'description' => 'The tacas secret for a new device',
			"method" => "textbox_password",
			"max_length" => 80,
			"default" => ""
		),
		"linkdiscovery_graph_header" => array(
			"friendly_name" => "Graph creation",
			"method" => "spacer",
			),
		"linkdiscovery_host_template" => array(
			"friendly_name" => "host Template",
			"description" => "Select a Host Template that device will be matched to.",
			"method" => "drop_array",
			"array" => $linkdiscovery_get_host_template,
			),
		'linkdiscovery_CPU_graph' => array(
			'friendly_name' => 'CPU Graph',
			'description' => 'Enable CPU Graph, and which template to use',
			'method' => "drop_array",
			'array' => $linkdiscovery_cpu_graph, 
			),
		'linkdiscovery_status_graph' => array(
			'friendly_name' => 'Status Graph',
			'description' => 'Enable Status Graph, and which type to use',
			'method' => "drop_array",
			'array' => linkdiscovery_get_graph_template('status'), 
			),
		'linkdiscovery_traffic_graph' => array(
			'friendly_name' => 'Traffic Graph',
			'description' => 'Enable Traffic Graph, and which type to use',
			'method' => "drop_array",
			'array' => linkdiscovery_get_graph_template('traffic'), 
			),
		'linkdiscovery_packets_graph' => array(
			'friendly_name' => 'Packets Graph',
			'description' => 'Enable Non-unicast or other packets Graph, and which type to use',
			'method' => "drop_array",
			'array' => linkdiscovery_get_graph_template('Packets'), 
			),
		'linkdiscovery_errors_graph' => array(
			'friendly_name' => 'Error Graph',
			'description' => 'Enable Errors and Discard packets Graph, and which type to use',
			'method' => "drop_array",
			'array' => linkdiscovery_get_graph_template('Errors'), 
			),
		'linkdiscovery_status_thold' => array(
			'friendly_name' => 'Status Threshold',
			'description' => 'Enable Status Threshold, and which template to use',
			'method' => "drop_array",
			'array' => linkdiscovery_get_thold_template('status'), 
			),
		'linkdiscovery_traffic_thold' => array(
			'friendly_name' => 'Traffic Threshold',
			'description' => 'Enable traffic Threshold, and which template to use',
			'method' => "drop_array",
			'array' => linkdiscovery_get_thold_template('traffic'), 
			),
		"linkdiscovery_other_header" => array(
			"friendly_name" => "other option",
			"method" => "spacer",
			),
		"linkdiscovery_keep_wifi" => array(
			"friendly_name" => "Keep the link with WiFi Access Point",
			"description" => "Should we keep WifiAccess point as peer host (no CDP scan on it, no save into cacti, just the link).",
			'method' => 'checkbox',
			'default' => 'on'
			),
		'linkdiscovery_no_scan' => array(
			'friendly_name' => "Don't scan this host",
			'description' => 'Comma separeted hostname, where scanning is prohibited. Hostname must match hostname defined on cacti',
			'method' => 'textarea',
			'class' => 'textAreaNotes',
			'textarea_rows' => '5',
			'textarea_cols' => '80',
		),
		'linkdiscovery_log_debug' => array(
			'friendly_name' => 'Debug Log',
			'description' => 'Enable logging of debug messages during LinkDiscovery',
			'method' => 'checkbox',
			'default' => 'off'
			),
		"linkdiscovery_tree" => array(
			"friendly_name" => "Tree location",
			"description" => "Select a location in the tree to place the host discovered.",
			"method" => "drop_array",
			"array" => linkdiscovery_get_tree_headers(),
			),
	);
}

function linkdiscovery_show_tab () {
	global $config;
	include_once($config["library_path"] . "/database.php");

	if (api_user_realm_auth('linkdiscovery.php')) {
		if (!substr_count($_SERVER["REQUEST_URI"], "linkdiscovery.php")) {
			print '<a href="' . $config['url_path'] . 'plugins/linkdiscovery/linkdiscovery.php"><img src="' . $config['url_path'] . 'plugins/linkdiscovery/images/tab_discover.gif" alt="LinkDiscovery" align="absmiddle" border="0"></a>';
		}else{
			print '<a href="' . $config['url_path'] . 'plugins/linkdiscovery/linkdiscovery.php"><img src="' . $config['url_path'] . 'plugins/linkdiscovery/images/tab_discover_down.gif" alt="LinkDiscovery" align="absmiddle" border="0"></a>';
		}
	}
}

function linkdiscovery_config_arrays () {
	global $config, $settings, $linkdiscovery_poller_frequencies, $linkdiscovery_get_host_template, $linkdiscovery_cpu_graph;

	$linkdiscovery_poller_frequencies = array(
		"disabled" => "Disabled",
		"60" => "Every 1 Hour",
		"120" => "Every 2 Hours",
		"240" => "Every 4 Hours",
		"360" => "Every 6 Hours",
		"480" => "Every 8 Hours",
		"720" => "Every 12 Hours",
		"1440" => "Every Day",
		"10080" => "Every Week",
		"20160" => "Every 2 Weeks",
		"40320" => "Every 4 Weeks"
		);


	// get template list
	$host_template_names = db_fetch_assoc("SELECT id, name FROM host_template");
	$linkdiscovery_get_host_template = array();

	if (sizeof($host_template_names) > 0) {
		foreach ($host_template_names as $ht) {
			$linkdiscovery_get_host_template[$ht['id']] = $ht['name'];
		}
	}

	// get CPU graph template
	$linkdiscovery_cpu_graph = array();
	$dbquery = db_fetch_assoc("SELECT graph_templates.id, graph_templates.name
			FROM host_template,host_template_graph,graph_templates 
			WHERE host_template.id=" . read_config_option('linkdiscovery_host_template') . "
			AND host_template.id=host_template_graph.host_template_id
			AND graph_templates.id=host_template_graph.graph_template_id AND graph_templates.name LIKE '%cpu%'");

	if (sizeof($dbquery) > 0) {
		$linkdiscovery_cpu_graph[0] = "Disabled";
		foreach ($dbquery as $ht) {
		$linkdiscovery_cpu_graph[$ht['id']] = $ht['name'];
		}
	}
	
}

function linkdiscovery_draw_navigation_text ($nav) {
	$nav["linkdiscovery.php:"] = array("title" => "LinkDiscovery", "mapping" => "", "url" => "linkdiscovery.php", "level" => "0");

	$nav['linkdiscovery.php:'] = array('title' => 'LinkDiscovery', 'mapping' => 'index.php:', 'url' => 'linkdiscovery.php', 'level' => '1');
	return $nav;
}

function linkdiscovery_setup_table () {
	global $config, $database_default;
	include_once($config["library_path"] . "/database.php");

	$data = array();
	$data['columns'][] = array('name' => 'id', 'type' => 'mediumint(8)', 'NULL' => false, 'default' => '0');
	$data['columns'][] = array('name' => 'host_template_id', 'type' => 'mediumint(8)', 'NULL' => false, 'default' => '0');
	$data['columns'][] = array('name' => 'description', 'type' => 'varchar(150)', 'NULL' => false, 'default' => '');
	$data['columns'][] = array('name' => 'hostname', 'type' => 'varchar(250)', 'NULL' => true);
	$data['columns'][] = array('name' => 'community', 'type' => 'varchar(100)', 'NULL' => false, 'default' => '');
	$data['columns'][] = array('name' => 'snmp_version', 'type' => 'tinyint(1)', 'unsigned' => 'unsigned', 'NULL' => false, 'default' => '1');
	$data['columns'][] = array('name' => 'snmp_username', 'type' => 'varchar(50)', 'NULL' => true);
	$data['columns'][] = array('name' => 'snmp_password', 'type' => 'varchar(50)', 'NULL' => true);
	$data['columns'][] = array('name' => 'snmp_auth_protocol', 'type' => 'char(5)', 'default' =>  '');
	$data['columns'][] = array('name' => 'snmp_priv_passphrase', 'type' => 'varchar(200)', 'default' => '');
	$data['columns'][] = array('name' => 'snmp_priv_protocol', 'type' => 'char(6)', 'default' => '');
	$data['columns'][] = array('name' => 'snmp_context', 'type' => 'varchar(64)', 'default' => '');
	$data['columns'][] = array('name' => 'scanned', 'type' => 'tinyint(1)', 'default' => '0');
	$data['primary'] = 'description';
	$data['keys'][] = array('name' => 'hostname', 'columns' => 'hostname');
	$data['type'] = 'MyISAM';
	$data['comment'] = 'Plugin linkdiscovery - Table of linkdiscovery discovered hosts';
	api_plugin_db_table_create('linkdiscovery', 'plugin_linkdiscovery_hosts', $data);

	$data = array();
	$data['columns'][] = array('name' => 'host_id_src', 'type' => 'mediumint(8)', 'unsigned' => 'unsigned', 'NULL' => false, 'default' => '0');
	$data['columns'][] = array('name' => 'host_id_dst', 'type' => 'mediumint(8)', 'unsigned' => 'unsigned', 'NULL' => false, 'default' => '0');
	$data['columns'][] = array('name' => 'snmp_index_src', 'type' => 'int(10)', 'unsigned' => 'unsigned', 'NULL' => false, 'default' => '0');
	$data['columns'][] = array('name' => 'snmp_index_dst', 'type' => 'int(10)', 'unsigned' => 'unsigned', 'NULL' => false, 'default' => '0');
	$data['primary'] = "host_id_src`,`snmp_index_src";
	$data['keys'][] = array('name' => 'host_id_src', 'columns' => 'host_id_src');
	$data['keys'][] = array('name' => 'snmp_index_src', 'columns' => 'snmp_index_src');
	$data['type'] = 'MyISAM';
	$data['comment'] = 'Plugin linkdiscovery - Table of linkdiscovery discovered interface';
	api_plugin_db_table_create('linkdiscovery', 'plugin_linkdiscovery_intf', $data);
}

function linkdiscovery_poller_bottom () {
	global $config;

	include_once($config["library_path"] . "/database.php");

	if (read_config_option("linkdiscovery_collection_timing") == "disabled")
		return;

	$t = read_config_option("linkdiscovery_last_poll");

	/* Check for the polling interval, only valid with the Multipoller patch */
	$poller_interval = read_config_option("poller_interval");
	if (!isset($poller_interval)) {
		$poller_interval = 300;
	}

	if ($t != '' && (time() - $t < $poller_interval))
		return;

	$command_string = trim(read_config_option("path_php_binary"));

	// If its not set, just assume its in the path
	if (trim($command_string) == '')
		$command_string = "php";
	$extra_args = ' -q ' . $config['base_path'] . '/plugins/linkdiscovery/findhosts.php';

	exec_background($command_string, $extra_args);

	if ($t == "")
		$sql = "insert into settings values ('linkdiscovery_last_poll','" . time() . "')";
	else
		$sql = "update settings set value = '" . time() . "' where name = 'linkdiscovery_last_poll'";
	$result = mysql_query($sql) or die (mysql_error());
}

function linkdiscovery_get_tree_headers() {
	$headers = array();
	$trees = db_fetch_assoc("SELECT id, name FROM graph_tree ORDER by ID");
	foreach ($trees as $tree) {
		$headers[($tree['id'] + 1000000)] = $tree['name'];
		$items = db_fetch_assoc("SELECT id, title, order_key FROM graph_tree_items WHERE graph_tree_id = " . $tree['id'] . " AND host_id = 0 AND sort_children_type = 4 ORDER BY order_key");
		if (sizeof($items) > 0) {
			foreach ($items as $item) {
				$order_key = $item['order_key'];
				$len = strlen($order_key);
				$spaces = '';
				for ($a = 0; $a < $len; $a=$a+3) {
					$n = substr($order_key, $a, 3);
					if ($n != '000') {
						$spaces .= '--';
					} else {
						$a = $len;
					}
				}

				$headers[$item['id']] = $spaces . $item['title'];
			}
		}
	}
	return $headers;
}

function linkdiscovery_get_thold_template( $type ) {
	global $thold;

	if( $thold = false )
		return;

	$header = array();
	
	$dbquery = db_fetch_assoc("SELECT thold_template.id, thold_template.name
			FROM thold_template 
			WHERE thold_template.data_source_name LIKE'%$type%'");


	if (sizeof($dbquery) > 0) {
		$header[0] = "Disabled";
		foreach ($dbquery as $ht) {
		$header[$ht['id']] = $ht['name'];
		}
	}

	return $header;
}

function linkdiscovery_get_graph_template( $type) {
	$header = array();
			$dbquery = db_fetch_assoc("SELECT snmp_query_graph.id, snmp_query_graph.name
			FROM host_template_snmp_query,snmp_query,snmp_query_graph,graph_templates 
			WHERE host_template_snmp_query.host_template_id=" . read_config_option('linkdiscovery_host_template') . "
			AND host_template_snmp_query.snmp_query_id=snmp_query.id
			AND snmp_query.id=snmp_query_graph.snmp_query_id
			AND snmp_query_graph.graph_template_id=graph_templates.id
			AND graph_templates.name LIKE'%$type%'");

	if (sizeof($dbquery) > 0) {
		$header[0] = "Disabled";
		foreach ($dbquery as $ht) {
		$header[$ht['id']] = $ht['name'];
		}
	}

	return $header;
}

function linkdiscovery_utilities_action ($action) {
	if ($action == 'linkdiscovery_clear') {
		// query the host id to remove from the tree
		$dbquery = db_fetch_assoc("SELECT id from plugin_linkdiscovery_hosts ORDER by id");
		if (sizeof($dbquery) > 0) {
			$tree = read_config_option("linkdiscovery_tree");
			$tree_id = $tree - 1000000;
			foreach ($dbquery as $host_id) {
				db_execute("DELETE FROM graph_tree_items where graph_tree_id=".$tree_id );			}
			db_execute('DELETE FROM plugin_linkdiscovery_hosts');
			db_execute('DELETE FROM plugin_linkdiscovery_intf');
		}
	
		include_once('./include/top_header.php');
		utilities();
		include_once('./include/bottom_footer.php');
	}
	return $action;
}

function linkdiscovery_utilities_list () {
	global $colors;

	html_header(array("LinkDiscovery Results"), 2);
	?>
	<tr bgcolor="#<?php print $colors["form_alternate1"];?>">
		<td class="textArea">
			<a href='utilities.php?action=linkdiscovery_clear'>Clear LinkDiscovery Results</a>
		</td>
		<td class="textArea">
			This will clear the results from the Link Discovery data.
		</td>
	</tr>
	<?php
}

function linkdiscovery_device_remove( $hosts_id ){
	//array(1) { [0]=> string(4) "1921" } device remove : 
link_log("remove:".count($hosts_id) );
	if( sizeof($hosts_id) ) {
		$usearuba = read_config_option("linkdiscovery_aruba_server");

		foreach( $hosts_id as $host_id) {
			// remove host from plugin_linkdiscovery_hosts and plugin_linkdiscovery_intf
			db_execute("DELETE FROM plugin_linkdiscovery_hosts where id=".$host_id );
			db_execute("DELETE FROM plugin_linkdiscovery_intf where host_id_dst=".$host_id );
			db_execute("DELETE FROM plugin_linkdiscovery_intf where host_id_src=".$host_id );

link_log("remove:".var_dump($usearuba) );
			if($usearuba ){
				// call aruba REST API
//				remove_aruba_device($host_id );
			}
		}

	}


	return $host_id;
}

function linkdiscovery_add_device( $host_id ) {
	$useipam = read_config_option("linkdiscovery_useipam");
	
	if( $useipam ){
		$ipamurl = read_config_option("linkdiscovery_ipam_url");
		//$host_id["hostname"] do a nslook if necessary
		$ip = gethostbyname($host_id['hostname']);
		//https://ipam.lausanne.ch/rpc/iplocator_ng_import_device.php?hostaddr=$host_id&site_id=4
		$url = $ipamurl . "/rpc/iplocator_ng_import_device.php?hostaddr=". $ip ."&site_id=4";
		
        $handle = curl_init();
		curl_setopt( $handle, CURLOPT_URL, $url );
		curl_setopt( $handle, CURLOPT_POST, true );
		curl_setopt( $handle, CURLOPT_HEADER, true );
		curl_setopt( $handle, CURLOPT_SSL_VERIFYPEER, false );
		curl_setopt( $handle, CURLOPT_RETURNTRANSFER, true );
		curl_setopt( $handle, CURLOPT_HTTPHEADER, array( 
								'X-IPM-Username:c19jYWN0aW5ldHdvcmthZG0=', 
								'X-IPM-Password:VU5BVzJtM3NGRis5dVN6WmY=',
								'Content-Type:application/json; charset=UTF-8',
								'cache-control:no-cache') );

		$response = curl_exec($handle);
		$error = curl_error($handle);
		$result = array( 'header' => '',
                         'body' => '',
                         'curl_error' => '',
                         'http_code' => '',
                         'last_url' => '');

        $header_size = curl_getinfo($handle,CURLINFO_HEADER_SIZE);
        $result['header'] = substr($response, 0, $header_size);
        $result['body'] = substr( $response, $header_size );
        $result['http_code'] = curl_getinfo($handle,CURLINFO_HTTP_CODE);
        $result['last_url'] = curl_getinfo($handle,CURLINFO_EFFECTIVE_URL);

        if ( $result['http_code'] > "299" )
        {
            $result['curl_error'] = $error;
        	link_log( "ipam error: ". $result['curl_error'] );
        }
       
        link_log( "ipam result: ". $result['body'] );

		curl_close($handle);

	}
	
	$usearuba = read_config_option("linkdiscovery_aruba_server");
	if($usearuba){
		// call aruba REST API
		add_aruba_device($host_id );
	}

	return $host_id;
}

function aruba_get_oauth() {
	$arubaurl = read_config_option("linkdiscovery_aruba_server");

	$url = $arubaurl . '/oauth';
//**** get the auth token
	$handle = curl_init();
	curl_setopt( $handle, CURLOPT_URL, $url );
	curl_setopt( $handle, CURLOPT_POST, true );
	curl_setopt( $handle, CURLOPT_HEADER, true );
	curl_setopt( $handle, CURLOPT_SSL_VERIFYPEER, false );
	curl_setopt( $handle, CURLOPT_RETURNTRANSFER, true );
	curl_setopt( $handle, CURLOPT_HTTPHEADER, array( 'Content-Type:application/json; charset=UTF-8','cache-control:no-cache') );
    curl_setopt( $handle, CURLOPT_POSTFIELDS, 
        '{
        "grant_type": "client_credentials",
        "client_id": "LinkDiscovery",
        "client_secret": "r4rL0DvX+/RQBeSoHvH5umxPJ40QTuoWRxh5g9o8lLIU"
        }'
    );


	$response = curl_exec($handle);
	$error = curl_error($handle);
	$result = array( 'header' => '',
                     'body' => '',
					 'curl_error' => '',
					 'http_code' => '',
					 'last_url' => ''
					 );

    $header_size = curl_getinfo($handle,CURLINFO_HEADER_SIZE);
	$result['header'] = substr($response, 0, $header_size);
	$result['body'] = substr( $response, $header_size );
	$result['http_code'] = curl_getinfo($handle,CURLINFO_HTTP_CODE);
	$result['last_url'] = curl_getinfo($handle,CURLINFO_EFFECTIVE_URL);

	if ( $result['http_code'] > "299" )
    {
		$result['curl_error'] = $error;
		link_log("oauth error: ". $result['body'] ."\n" );
        curl_close($handle);
		$token = false;
    } else {
       
		$response = json_decode( $result['body'], true );
		$token = $response['access_token'];
	}

	return $token;
}

function add_aruba_device( $host_id ) {
	$arubaurl = read_config_option("linkdiscovery_aruba_server");
	$arubatacacs = read_config_option("linkdiscovery_aruba_tacacs_secret");
	$arubaradius = read_config_option("linkdiscovery_aruba_radius_secret");
	
	$token = aruba_get_oauth();
	if( ! $token ) {
		return;
	}
		
//**** add the device
	$ip = gethostbyname($host_id['hostname']);
	$url = $arubaurl . '/network-device';
	$handle = curl_init();
	curl_setopt( $handle, CURLOPT_URL, $url );
	curl_setopt( $handle, CURLOPT_POST, true );
	curl_setopt( $handle, CURLOPT_HEADER, true );
	curl_setopt( $handle, CURLOPT_SSL_VERIFYPEER, false );
	curl_setopt( $handle, CURLOPT_RETURNTRANSFER, true );
	curl_setopt( $handle, CURLOPT_HTTPHEADER, array( 'Content-Type:application/json; charset=UTF-8',
													 'cache-control:no-cache',
													 "Authorization: Bearer $token") );

    $desc = $host_id['description'];
    $name = $host_id['description'];
    if( $host_id['snmp_version'] == '2' ) {
    	$snmp_version = "V2C";
    } else if( $host_id['snmp_version'] == '3' ) {
    	$snmp_version = "V3";
	} else $snmp_version = "V1";

    $snmp_community = $host_id['snmp_community'];
    curl_setopt( $handle, CURLOPT_POSTFIELDS,
        "{
			\"description\": \"$desc\",
			\"name\": \"$name\",
			\"ip_address\" : \"$ip\",
			\"radius_secret\": \"$arubaradius\",
			\"tacacs_secret\": \"$arubatacacs\",
			\"vendor_name\": \"Cisco\",
			\"coa_capable\": true,
			\"coa_port\":3799,
			\"snmp_read\": {
				\"force_read\": true,
				\"read_arp_info\": true,
				\"snmp_version\" : \"$snmp_version\",
				\"community_string\": \"$snmp_community\"
				}
        }"
    );
	
	$response = curl_exec($handle);
	$error = curl_error($handle);
	$result = array( 'header' => '',
                     'body' => '',
					 'curl_error' => '',
					 'http_code' => '',
					 'last_url' => '');

    $header_size = curl_getinfo($handle,CURLINFO_HEADER_SIZE);
	$result['header'] = substr($response, 0, $header_size);
	$result['body'] = substr( $response, $header_size );
	$result['http_code'] = curl_getinfo($handle,CURLINFO_HTTP_CODE);
	$result['last_url'] = curl_getinfo($handle,CURLINFO_EFFECTIVE_URL);

	if ( $result['http_code'] > "299" )
        {
			link_log("aruba add error: ". $result['body'] ."\n" );
        }
       
	curl_close($handle);

}

function remove_aruba_device( $host_id ) {
	$arubaurl = read_config_option("linkdiscovery_aruba_server");
	
link_log("aruba remove:".var_dump($host_id) );

	$token = aruba_get_oauth();
	if( ! $token ) {
		return;
	}
		
//**** remove the device
	$hostname = $host_id['hostname'];
	$url = $arubaurl . '/network-device/name/'.$hostname;
	$handle = curl_init();
	curl_setopt( $handle, CURLOPT_URL, $url );
	curl_setopt( $handle, CURLOPT_HEADER, true );
	curl_setopt( $handle, CURLOPT_SSL_VERIFYPEER, false );
	curl_setopt( $handle, CURLOPT_RETURNTRANSFER, true );
	curl_setopt( $handle, CURLOPT_HTTPHEADER, array( 'Content-Type:application/json; charset=UTF-8',
													 'cache-control:no-cache',
													 "Authorization: Bearer $token") );

    curl_setopt( $handle, CURLOPT_CUSTOMREQUEST, "DELETE" );
	$response = curl_exec($handle);
	$error = curl_error($handle);
	
	$result = array( 'header' => '',
                     'body' => '',
					 'curl_error' => '',
					 'http_code' => '',
					 'last_url' => '');

    $header_size = curl_getinfo($handle,CURLINFO_HEADER_SIZE);
	$result['header'] = substr($response, 0, $header_size);
	$result['body'] = substr( $response, $header_size );
	$result['http_code'] = curl_getinfo($handle,CURLINFO_HTTP_CODE);
	$result['last_url'] = curl_getinfo($handle,CURLINFO_EFFECTIVE_URL);

	if ( $result['http_code'] > "299" )
        {
			link_log("aruba remove error: ". $result['body'] ."\n" );
        }
       
	link_log( "aruba remove result: ". $result['body']  );

	curl_close($handle);

}

function link_log( $text ){
    $dolog = read_config_option('linkdiscovery_log_debug');
    if( $dolog ) cacti_log( $text, false, "LINKDISCOVERY" );

}

?>
